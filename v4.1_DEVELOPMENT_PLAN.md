# v4.1 Development Plan - Async Metadata I/O

**Goal:** Eliminate workqueue leak by implementing async metadata I/O with cancellation support  
**Started:** October 22, 2025  
**Target:** v4.1 Alpha - December 2025  
**Effort Estimate:** ~2 weeks

---

## Current Status: Phase 1 - Planning & Design

### Objectives
- [ ] Review async metadata plan (ASYNC_METADATA_PLAN.md)
- [ ] Create detailed implementation checklist
- [ ] Set up development branch
- [ ] Identify all blocking I/O points
- [ ] Design async API signatures

---

## Implementation Phases

### Phase 1: Metadata Module Refactoring (Week 1)
**Focus:** Add async variants to dm-remap-v4-metadata module

**Tasks:**
- [ ] Create `dm_remap_write_metadata_v4_async()` function
- [ ] Implement `dm_remap_write_metadata_endio()` completion handler
- [ ] Add cancellation support with atomic flags
- [ ] Add timeout handling (5 second default)
- [ ] Update metadata module API header
- [ ] Unit test async functions in isolation
- [ ] Ensure backward compatibility with sync version

**Files to modify:**
- `src/dm-remap-v4-metadata.c` (create async variants)
- `include/dm-remap-v4-metadata.h` (add async API)
- `src/dm-remap-v4-real-main.c` (device structure updates)

### Phase 2: Main Module Integration (Week 1-2)
**Focus:** Integrate async I/O into work functions

**Tasks:**
- [ ] Add `completion` field to device structure
- [ ] Add `metadata_write_cancelled` atomic flag
- [ ] Refactor `dm_remap_sync_metadata_work()` to use async I/O
- [ ] Update `dm_remap_write_persistent_metadata()` wrapper
- [ ] Modify presuspend to cancel in-flight I/O
- [ ] Update destructor to properly destroy workqueue
- [ ] Remove msleep() delay hack

**Files to modify:**
- `src/dm-remap-v4-real-main.c` (work function refactor)

### Phase 3: Testing & Validation (Week 2)
**Focus:** Comprehensive testing of async I/O

**Tasks:**
- [ ] Test device removal during idle state
- [ ] Test device removal during active metadata write
- [ ] Test device removal during error recovery
- [ ] Test rapid create/destroy cycles (stress test)
- [ ] Test module unload with active devices
- [ ] Verify no workqueue leaks (check kernel logs)
- [ ] Verify no memory leaks (kmemleak)
- [ ] Performance benchmarking (before/after)

**Test scripts to create:**
- `tests/test_v4.1_async_removal.sh`
- `tests/stress_test_lifecycle.sh`
- `tests/performance_benchmark.sh`

### Phase 4: Documentation & Release (Week 2)
**Focus:** Update documentation and prepare release

**Tasks:**
- [ ] Update ASYNC_METADATA_PLAN.md with actual implementation
- [ ] Document API changes in metadata module
- [ ] Update RELEASE_v4.1.md
- [ ] Create migration guide from v4.0 to v4.1
- [ ] Update README with v4.1 features
- [ ] Tag v4.1-alpha for testing

---

## Development Environment Setup

### Create Development Branch
```bash
cd /home/christian/kernel_dev/dm-remap
git checkout -b v4.1-async-io
git push -u origin v4.1-async-io
```

### Development Workflow
1. Work in `v4.1-async-io` branch
2. Commit frequently with descriptive messages
3. Test after each major change
4. Merge to main only when stable

---

## Key Design Decisions

### 1. Async I/O Architecture
**Approach:** Non-blocking bio submission with completion callbacks
**Rationale:** Allows cancellation of in-flight I/O operations

### 2. Cancellation Strategy
**Approach:** Atomic flag checked in completion handler
**Rationale:** Safe from interrupt context, no race conditions

### 3. Timeout Handling
**Approach:** 5 second timeout with configurable override
**Rationale:** Prevent indefinite waits, allow cancellation

### 4. Backward Compatibility
**Approach:** Keep sync version as fallback, add async as new API
**Rationale:** Allows gradual migration, easier testing

---

## Success Criteria

**v4.1 is ready when:**
- [ ] No workqueue leaks on device removal
- [ ] `destroy_workqueue()` succeeds every time
- [ ] All v4.0 tests still passing
- [ ] New async tests passing
- [ ] No performance regression
- [ ] No memory leaks
- [ ] Clean module unload every time
- [ ] Documentation complete

---

## Risk Mitigation

**Risk 1:** Async I/O introduces new bugs
- **Mitigation:** Extensive testing, keep sync version as fallback

**Risk 2:** Performance regression
- **Mitigation:** Benchmark before/after, optimize if needed

**Risk 3:** Completion handler complexity
- **Mitigation:** Keep handlers simple, minimal work in interrupt context

**Risk 4:** Race conditions with cancellation
- **Mitigation:** Use atomic operations, careful locking strategy

---

## Next Steps

**Immediate actions:**
1. Create `v4.1-async-io` development branch
2. Review metadata module code to understand current implementation
3. Design async API signatures
4. Start implementing Phase 1

**Ready to begin?** Let's create the branch and start Phase 1!
