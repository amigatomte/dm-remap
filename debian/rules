#!/usr/bin/make -f

export DH_VERBOSE = 1

%:
	dh $@

# DKMS source package - no kernel-specific building
override_dh_auto_build:
	# Clean any build artifacts first
	make -C src clean || true
	# Don't build kernel modules here - DKMS will handle it per kernel
	echo "DKMS source package - kernel compilation deferred to install time"

override_dh_auto_install:
	# Clean source directory before installing
	make -C src clean || true
	
	# Install DKMS source files
	mkdir -p debian/dm-remap-dkms/usr/src/dm-remap-1.0.0
	
	# Copy only source files, not build artifacts
	cp -r src debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/
	# Clean the copied source directory
	make -C debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/src clean || true
	# Remove any build artifacts
	find debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/src -name "*.o" -delete
	find debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/src -name "*.ko" -delete
	find debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/src -name "*.mod" -delete
	find debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/src -name ".*.d" -delete
	
	cp -r include debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/
	cp Makefile debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/
	cp dkms.conf debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/
	cp LICENSE debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/
	cp README.md debian/dm-remap-dkms/usr/src/dm-remap-1.0.0/
	
	# Copy documentation to separate package
	mkdir -p debian/dm-remap-doc/usr/share/doc/dm-remap
	install -D -m 0644 README.md debian/dm-remap-doc/usr/share/doc/dm-remap/
	install -D -m 0644 LICENSE debian/dm-remap-doc/usr/share/doc/dm-remap/
	if [ -d docs ]; then cp -r docs/* debian/dm-remap-doc/usr/share/doc/dm-remap/ || true; fi

override_dh_auto_test:
	# Skip tests during source package build
	echo "DKMS source package - tests deferred to runtime"

override_dh_strip:
	# No binaries to strip in source package
	true

override_dh_usrlocal:
	# Skip this step for source packages
	true

clean:
	make -C src clean || true
	dh_clean
