#!/bin/bash

set -e

# 

PACKAGE_NAME="dm-remap"
PACKAGE_VERSION="1.0.0"

# Pre-removal: Clean up DKMS and unload module
if [ "$1" = "remove" ]; then
    echo "Checking for active dm-remap devices..."
    
    # Check if any dm-remap devices exist
    if dmsetup ls 2>/dev/null | grep -q remap; then
        echo "WARNING: Active dm-remap devices found!"
        echo "You should remove dm-remap devices before uninstalling:"
        echo "  sudo dmsetup remove <device-name>"
        echo ""
    fi
    
    # Try to unload module if not in use
    if lsmod 2>/dev/null | grep -q dm_remap; then
        echo "Attempting to unload dm-remap module..."
        modprobe -r dm_remap 2>/dev/null || \
            echo "Note: Module could not be unloaded (may be in use)"
    fi
    
    # Unregister from DKMS
    if command -v dkms &> /dev/null; then
        echo "Unregistering ${PACKAGE_NAME} ${PACKAGE_VERSION} from DKMS..."
        
        # Remove from DKMS for all installed kernels
        for kernel_dir in /lib/modules/*/build; do
            kernel_version=$(basename $(dirname "$kernel_dir"))
            if [ -d "$kernel_dir" ]; then
                dkms remove -m "${PACKAGE_NAME}" -v "${PACKAGE_VERSION}" -k "$kernel_version" 2>/dev/null || true
            fi
        done
        
        # Remove from DKMS completely
        dkms remove -m "${PACKAGE_NAME}" -v "${PACKAGE_VERSION}" --all 2>/dev/null || true
        echo "${PACKAGE_NAME} unregistered from DKMS"
    fi
fi
