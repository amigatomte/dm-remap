# dm-remap v4.0.1 Release Notes

**Release Date**: October 15, 2025  
**Type**: Critical Enhancement (Hotfix)  
**Priority**: High - Addresses fundamental design limitation

---

## Overview

Version 4.0.1 introduces **intelligent spare device sizing**, addressing a critical limitation identified by the community where v4.0 Phase 1 required spare devices to be ≥105% of main device size.

### The Problem

In v4.0 Phase 1, the spare device sizing validation was overly conservative:

```c
// OLD (v4.0 Phase 1) - WASTEFUL!
min_spare_size = main_size + (main_size / 20);  // Always 105% of main
```

**Impact:**
- 1TB main device required 1.05TB spare device
- Defeated the purpose of spare pool architecture
- Users correctly noted: "Just use RAID1 mirroring instead"
- Wasted 95%+ of potential storage efficiency

### The Solution

v4.0.1 implements **intelligent spare sizing** with realistic calculations:

```c
// NEW (v4.0.1) - OPTIMIZED!
// Components:
// 1. Metadata base: 4KB
// 2. Expected bad sectors: main_size * overhead_percent / 100
// 3. Mapping overhead: expected_bad_sectors * 64 bytes
// 4. Safety margin: 20% of calculated need

// Example: 1TB main, 2% expected bad sectors
// Spare needed: ~24GB (not 1.05TB!)
```

---

## What's New

### 1. Intelligent Spare Sizing Algorithm

**Default Mode (Optimized)**:
- Calculates realistic minimum based on actual needs
- Accounts for metadata + expected bad sectors + mapping overhead
- Includes 20% safety margin
- **Result**: 97% storage savings compared to v4.0 Phase 1

**Example Results**:

| Main Device | Old Requirement | New Requirement | Savings |
|-------------|----------------|-----------------|---------|
| 1GB         | 1.05GB (105%)  | 27MB (2.7%)     | 97%     |
| 100GB       | 105GB (105%)   | 2.7GB (2.7%)    | 97%     |
| 1TB         | 1.05TB (105%)  | 27GB (2.7%)     | 97%     |
| 10TB        | 10.5TB (105%)  | 270GB (2.7%)    | 97%     |

### 2. Module Parameters for Flexibility

```bash
# Expected bad sector percentage (default: 2%)
spare_overhead_percent=N     # Range: 0-20%

# Enable legacy v4.0 Phase 1 behavior (default: off)
strict_spare_sizing=0|1      # 0=optimized (default), 1=legacy

# Example usage:
sudo insmod dm-remap-v4-real.ko spare_overhead_percent=5
sudo insmod dm-remap-v4-real.ko strict_spare_sizing=1  # Legacy mode
```

### 3. Enhanced Validation Messages

The module now provides detailed sizing information:

```
Optimized spare sizing calculation:
  Main device: 2048000 sectors (1000 MB)
  Expected bad sectors (2%): 40960 sectors (20 MB)
  Metadata overhead: 5130 sectors (2565 KB)
  Minimum spare (with 20% safety margin): 55308 sectors (27 MB)
Excellent spare efficiency: 32 MB spare for 1000 MB main (3%)
```

### 4. Efficiency Warnings

The module intelligently warns when spare sizing suggests RAID1 would be better:

- **< 10% spare**: "Excellent spare efficiency"
- **10-50% spare**: "Good spare efficiency"
- **> 50% spare**: "Consider RAID1 mirroring"

---

## Upgrade Instructions

### From v4.0.0-phase1

1. **Rebuild the module**:
   ```bash
   cd /path/to/dm-remap
   git pull origin main
   make clean && make
   ```

2. **Unload old modules**:
   ```bash
   sudo dmsetup remove <your-devices>
   sudo rmmod dm-remap-v4-real
   sudo rmmod dm-remap-v4-spare-pool
   sudo rmmod dm-remap-v4-metadata
   sudo rmmod dm-remap-v4-setup-reassembly
   ```

3. **Load new modules** (optimized mode is default):
   ```bash
   sudo insmod src/dm-remap-v4-metadata.ko
   sudo insmod src/dm-remap-v4-spare-pool.ko
   sudo insmod src/dm-remap-v4-setup-reassembly.ko
   sudo insmod src/dm-remap-v4-real.ko
   ```

4. **Create devices with smaller spares**:
   ```bash
   # Now you can use much smaller spare devices!
   # Example: 50GB spare for 1TB main (instead of 1.05TB)
   ```

### Backward Compatibility

If you need the old v4.0 Phase 1 behavior:
```bash
sudo insmod dm-remap-v4-real.ko strict_spare_sizing=1
```

---

## Testing

A comprehensive test suite is provided:

```bash
# Demonstrates 97% storage savings
sudo ./tests/test_spare_sizing_v4.0.1.sh
```

**Test Results**:
- ✅ Test 1: Optimized mode (27MB spare for 1GB main)
- ✅ Test 2: Validation (correctly rejects insufficient spares)
- ✅ Test 3: Strict mode (legacy 1.05GB spare for compatibility)

---

## Technical Details

### Calculation Breakdown

For a 1TB main device with 2% expected bad sectors:

```
1. Metadata base: 4KB (base metadata structure)
2. Expected bad sectors: 1TB × 2% = 20GB
3. Mapping overhead: (20GB / 512) × 64 bytes = ~2.5MB
4. Base requirement: 4KB + 20GB + 2.5MB ≈ 20GB
5. Safety margin (20%): 20GB × 1.2 = 24GB
6. Total minimum spare: ~24GB
```

Compare to v4.0 Phase 1: **1.05TB** → **24GB** = **97.7% reduction!**

### Constants

```c
#define DM_REMAP_METADATA_BASE_SIZE   4096  /* Base metadata: 4KB */
#define DM_REMAP_METADATA_PER_MAPPING 64    /* Per-mapping: 64 bytes */
#define DM_REMAP_SAFETY_MARGIN_PCT    20    /* Safety margin: 20% */
```

---

## When to Use What

### Use Optimized Mode (Default) When:
- You have limited spare capacity
- You want efficient storage utilization
- Expected bad sectors are predictable (<5%)
- You need gradual bad sector management

### Use Strict Mode When:
- Backward compatibility with v4.0 Phase 1 required
- Maximum safety margin desired
- Spare capacity is not a concern

### Use RAID1 Mirroring When:
- Spare device is ≥50% of main device size
- Full redundancy is primary goal
- Storage efficiency is not critical

---

## Known Issues

None specific to v4.0.1. All v4.0 Phase 1 issues remain unchanged.

---

## Credits

**Issue Identified By**: Christian (User Feedback)  
**Original Observation**: "If the spare needs to be as big as the main device, you might as well use RAID mirroring instead"  
**Implementation**: dm-remap Development Team  
**Release Date**: October 15, 2025

---

## Next Steps

This enhancement may be backported or incorporated into:
- Priority 4: Metadata Format Migration Tool
- Future versions: Dynamic spare pool expansion

---

## Example Usage

### Before (v4.0 Phase 1)
```bash
# Wasteful! Need 1.05TB spare for 1TB main
dd if=/dev/zero of=/dev/spare bs=1M count=1075200
echo "0 2097152000 dm-remap-v4 /dev/main /dev/spare" | dmsetup create mydev
```

### After (v4.0.1)
```bash
# Efficient! Only need ~27GB spare for 1TB main
dd if=/dev/zero of=/dev/spare bs=1M count=28000
echo "0 2097152000 dm-remap-v4 /dev/main /dev/spare" | dmsetup create mydev
```

**Storage Savings**: 1.05TB - 27GB = **1,023GB freed** (97.4% reduction!)

---

## See Also

- [Quick Start Guide](../user/QUICK_START.md) - Updated with v4.0.1 sizing guidance
- [Demo README](../../demos/README.md) - Updated with realistic sizing examples
- [Test Results](test_spare_sizing_v4.0.1.sh) - Comprehensive validation

---

**Version**: 4.0.1  
**Module Version String**: "4.0.0-real" (unchanged for compatibility)  
**Git Tag**: `v4.0.1` (to be created)
